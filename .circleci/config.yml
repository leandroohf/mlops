version: 2.1

# --- Reusable Filters ---
on-push-main: &on-push-main
  branches:
    only:
      - main

# --- Workflows ---
workflows:
  bike-share-workflow:
    jobs:
      - test-gcloud-auth:
          filters:
            <<: *on-push-main
      - build-and-push-docker-image:
          filters:  # NOTE: allowed only on job level and not workflow level
            <<: *on-push-main
      - update-scheduler:
          requires:
            - build-and-push-docker-image
          filters:
            <<: *on-push-main
      - circleci-howto-job:
          filters:
            <<: *on-push-main

# --- Jobs ---
jobs:
  test-gcloud-auth:
    docker:
      - image: google/cloud-sdk:slim
    steps:
      - run:
          name: Decode Service Account Key
          command: |
            echo "$GCLOUD_SERVICE_KEY_BASE64" | base64 --decode > /tmp/gcp-key.json
      - run:
          name: Authenticate with Google Cloud
          command: |
            gcloud auth activate-service-account --key-file=/tmp/gcp-key.json
            gcloud config set project mlops-project-abacabb
      - run:
          name: List Authenticated Accounts
          command: gcloud auth list

  build-and-push-docker-image:
    docker: # NOTE: jobs need an executor: docker, machine, or macos
      - image: cimg/python:3.10
    steps:
      - checkout
      - setup_remote_docker:
          docker_layer_caching: true
      - run:
          name: Build Docker Image
          command: |
            echo "Current directory:"
            pwd
            echo "Listing files:"
            ls -la
            echo "Building Docker image..."
            docker build -t us-west1-docker.pkg.dev/mlops-project-abacabb/bike-share-project-registry/bike-share:latest \
              -f bike_share_batch_prediction_simple/Dockerfile \
              bike_share_batch_prediction_simple/ 

      - run:
          name: Authenticate and Push to Google Artifact Registry
          command: |
            echo "$GCLOUD_SERVICE_KEY_BASE64" | base64 --decode > /tmp/gcp-key.json
            gcloud auth activate-service-account --key-file=/tmp/gcp-key.json
            gcloud config set project mlops-project-abacabb
            gcloud auth configure-docker us-west1-docker.pkg.dev
            docker push us-west1-docker.pkg.dev/mlops-project-abacabb/bike-share-project-registry/bike-share:latest

  update-scheduler:
    docker:
      - image: google/cloud-sdk:slim
    steps:
      - checkout
      - run:
          name: Authenticate and Update Scheduler
          command: |
            echo "$GCLOUD_SERVICE_KEY_BASE64" | base64 --decode > /tmp/gcp-key.json
            gcloud auth activate-service-account --key-file=/tmp/gcp-key.json
            gcloud config set project mlops-project-abacabb
            gcloud scheduler jobs update http bike-pipeline-job-trigger \
                  --schedule="*/3 * * * *" \
                  --location=us-west1

  circleci-howto-job:
    docker: # NOTE: jobs need an executor: docker, machine, or macos
      - image: cimg/python:3.10
    steps:
      - run:
          name: Dummy Job
          command: echo "CircleCI how-to job"
